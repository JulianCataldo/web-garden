---
import licenser from '@wbmnky/license-report-generator';
import type { Props as baseProps } from './Props';

export interface Props extends baseProps {}
const props = { ...Astro.props } as Props;
/* ———————————————————————————————————————————— Typeguards + Fallbacks —————— */
const internalProps: string[] = [];

if (typeof props.depth !== 'number') props.depth = 2;
internalProps.push('depth');

if (typeof props.useDev !== 'boolean') props.useDev = true;
internalProps.push('useDev');

if (typeof props.nameText !== 'string') props.nameText = 'Package';
internalProps.push('nameText');

if (typeof props.authorText !== 'string') props.authorText = 'Author';
internalProps.push('authorText');

if (typeof props.licenseText !== 'string') props.licenseText = 'License';
internalProps.push('licenseText');

if (typeof props.linkText !== 'string') props.linkText = 'URL';
internalProps.push('linkText');
/* ············································ Extra HTML attributes ······· */
const extraAttrs: { [key: string]: string } = {};
Object.entries(props).forEach(([key, val]) => {
  if (internalProps.includes(key) === false) {
    extraAttrs[key] = `${val as string}`;
  }
});
/* —————————————————————————————————————————————————————————————————————————— */

interface Licenses {
  name?: string;
  author?: string | { name: string } | undefined;
  homepage?: string | undefined;
  license?: string | undefined;
  repository?: { url: string };
}

const options = {
  useDev: props.useDev,
  depth: props.depth,
};

const report =
  (await licenser.reporter
    .generate(options)
    .then((rep) => {
      const plain = rep.plain() as { licenses: Licenses[] };
      return plain.licenses;
    })
    .catch((/* error */) => {
      // console.log(error);
    })) || [];
---

<table class="licenses-report">
  <thead class="table-header">
    <tr class="row">
      <th class="header name">{props.nameText}</th>
      <th class="header author">{props.authorText}</th>
      <th class="header license">{props.licenseText}</th>
      <th class="header link">{props.linkText}</th>
    </tr>
  </thead>

  <tbody class="table-body">
    {report.map((row) => (
      <tr class="row">
        <td class="column name">{row.name}</td>

        <td class="column author">
          {typeof row.author === "string"
            ? row.author
            : row?.author?.name || "-"}
        </td>

        <td class="column license">{row.license}</td>

        <td class="column link">
          <a
            class="link is-external"
            href={row.homepage || row.repository.url}
            target="_blank"
            rel="noopener nofollow"
          >
            {row.homepage || row.repository.url}
          </a>
        </td>
      </tr>
    ))}
  </tbody>
</table>
